<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>عرض تفاصيل الطلب - الشركة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../assets/css/custom.css" />
    <script src="../assets/js/tailwind-config.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      /* Unify furniture inputs size and remove number spinners */
      .furn-input::-webkit-outer-spin-button,
      .furn-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .furn-input[type='number'] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body class="flex min-h-screen font-expo-arabic bg-[#fafafa] md:flex-row flex-col">
    <!-- Desktop Sidebar (Company) -->
    <aside
      id="desktop-sidebar"
      class="hidden lg:flex flex-col w-64 bg-white border-l border-gray-200 shadow-sm"
    >
      <div class="p-6 border-b border-gray-200">
        <a href="../index.html" class="flex items-center justify-center"
          ><img src="../assets/logo.svg" alt="نقلة" class="h-16 w-auto"
        /></a>
      </div>
      <nav class="flex-1 px-4 py-6">
        <ul class="space-y-2">
          <li>
            <a
              href="./dashboard.html"
              class="flex items-center gap-4 px-4 py-3 rounded-md text-gray-800 hover:bg-gray-50 transition-colors"
              ><img src="../assets/menu-icons/home.svg" alt="icon" class="w-6 h-6" /><span
                >لوحة التحكم</span
              ></a
            >
          </li>
          <li>
            <a
              href="#"
              onclick="return false;"
              class="flex items-center gap-4 px-4 py-3 rounded-md text-gray-800 hover:bg-gray-50 transition-colors"
              ><img src="../assets/menu-icons/who.svg" alt="icon" class="w-6 h-6" /><span
                >معلومات الحساب</span
              ></a
            >
          </li>
          <li>
            <a
              href="./manage-orders.html"
              class="flex items-center gap-4 px-4 py-3 rounded-md transition-colors sidebar-active"
              ><i class="fas fa-clipboard-list text-lg text-[#A9A9A9]"></i
              ><span>إدارة طلبات النقل</span></a
            >
          </li>
          <li>
            <a
              href="./manage-quotes.html"
              class="flex items-center gap-4 px-4 py-3 rounded-md text-gray-800 hover:bg-gray-50 transition-colors"
              ><i class="fas fa-file-invoice-dollar text-lg text-[#A9A9A9]"></i
              ><span>طلبات الأسعار</span></a
            >
          </li>
        </ul>
      </nav>
    </aside>

    <!-- Mobile Navbar -->
    <div class="lg:hidden bg-white text-gray-900 font-expo-arabic border-b border-gray-200">
      <div class="flex items-center justify-between px-4 py-4">
        <h1 class="text-lg font-semibold">عرض تفاصيل الطلب</h1>
        <button id="mobile-menu-button" onclick="toggleMobileMenu()" class="p-2">
          <i class="fas fa-bars text-xl text-[#00B8A9]"></i>
        </button>
      </div>
      <div id="mobile-menu-sidebar" class="hidden fixed inset-0 z-50">
        <div class="fixed inset-0 bg-black/50" onclick="toggleMobileMenu()"></div>
        <div
          class="fixed top-0 right-0 h-full w-full max-w-sm bg-white shadow-xl"
          style="animation: slideInRight 0.3s ease-out"
        >
          <div class="flex flex-col h-full">
            <div class="flex justify-end p-4">
              <button onclick="toggleMobileMenu()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            <nav class="flex-1 px-4 text-black">
              <ul class="space-y-0">
                <li>
                  <a
                    href="./dashboard.html"
                    onclick="toggleMobileMenu()"
                    class="flex items-center gap-4 px-4 py-3 hover:bg-gray-50 transition-colors"
                    ><img src="../assets/menu-icons/home.svg" alt="icon" class="w-6 h-6" /><span
                      class="text-[15px] text-gray-800"
                      >لوحة التحكم</span
                    ></a
                  >
                </li>
                <li>
                  <a
                    href="./manage-orders.html"
                    onclick="toggleMobileMenu()"
                    class="flex items-center gap-4 px-4 py-3 hover:bg-gray-50 transition-colors sidebar-active"
                    ><i class="fas fa-clipboard-list w-6 h-6 text-[#a9a9a9]"></i
                    ><span class="text-[15px] text-gray-800">إدارة طلبات النقل</span></a
                  >
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 p-4 bg-[#FAFAFA]">
      <div class="container mx-auto max-w-3xl space-y-6">
        <!-- Breadcrumb -->
        <div class="mb-2 text-sm text-[#7E7E7E]">
          <a href="./dashboard.html" class="hover:text-[#00B8A9]">لوحة التحكم</a>
          <span class="mx-2">—</span>
          <a href="./manage-orders.html" class="hover:text-[#00B8A9]">إدارة طلبات النقل</a>
          <span class="mx-2">—</span>
          <span class="text-[#312E37] font-medium">عرض تفاصيل الطلب</span>
        </div>

        <!-- Header Card -->
        <section class="bg-white rounded-2xl p-2">
          <div class="flex items-start justify-between mb-3">
            <div class="text-right">
              <h4 class="text-[#3C3D41] text-[14px] font-medium">منزل جديد</h4>
              <p class="text-[#868686] text-[12px]">#ORD938274</p>
            </div>
            <span
              class="px-4 py-2 bg-[#C8F4F1] text-[#01B4AA] border border-[#01B4AA] text-[12px] font-medium rounded-lg"
              >بانتظار البدء</span
            >
          </div>

          <!-- Collapsible: مراجعة تفاصيل الطلب -->
          <div class="border-t border-gray-50 bg-gray-50 p-3 rounded-xl">
            <button
              id="order-details-toggle"
              class="w-full flex items-center justify-between text-[14px] font-medium text-[#4B4B4B]"
            >
              <span>مراجعة تفاصيل الطلب</span>
              <i id="details-icon" class="fas fa-chevron-down"></i>
            </button>
            <div id="order-details" class="hidden grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
              <div class="bg-white rounded-lg p-3 border border-[#EAE9E999]">
                <h5
                  class="text-[14px] font-medium text-[#4B4B4B] mb-2 text-right border-b border-[#DFDFDF] py-3"
                >
                  الموعد والمرونة
                </h5>
                <div class="flex items-center gap-3 text-[13px] text-[#868686]">
                  <span>11:30 ص</span><i class="fas fa-clock text-gray-400"></i
                  ><span>19.10.2025</span><i class="fas fa-calendar text-gray-400"></i>
                </div>
              </div>
              <div class="bg-white rounded-lg p-3 border border-[#EAE9E999] md:col-span-2">
                <h5
                  class="text-[14px] font-medium text-[#4B4B4B] mb-2 text-right border-b border-[#DFDFDF] py-3"
                >
                  عنوان النقل الحالي
                </h5>
                <div class="text-[13px] text-[#868686] leading-7">
                  الرياض<br />حي الملقا شارع أنس بن مالك، 3679<br />بناء النور<br />طابق 4
                </div>
              </div>
              <div class="bg-white rounded-lg p-3 border border-[#EAE9E999] md:col-span-2">
                <h5
                  class="text-[14px] font-medium text-[#4B4B4B] mb-2 text-right border-b border-[#DFDFDF] py-3"
                >
                  العنوان المراد النقل إليه
                </h5>
                <div class="text-[13px] text-[#868686] leading-7">
                  الرياض<br />حي العلا شارع فلسطين 5843<br />بناء النور<br />طابق 7
                </div>
              </div>
              <div class="bg-white rounded-lg p-3 border border-[#EAE9E999] md:col-span-2">
                <h5
                  class="text-[14px] font-medium text-[#4B4B4B] mb-2 text-right border-b border-[#DFDFDF] py-3"
                >
                  الخدمات الإضافية
                </h5>
                <div class="flex flex-wrap gap-2 text-[12px]">
                  <span class="px-3 py-1 bg-white text-[#00B8A9] rounded-md border border-gray-200"
                    >تغليف محكم</span
                  >
                  <span class="px-3 py-1 bg-white text-[#00B8A9] rounded-md border border-gray-200"
                    >تأمين ضد الفقد والكسر</span
                  >
                  <span class="px-3 py-1 bg-white text-[#00B8A9] rounded-md border border-gray-200"
                    >تفكيك وتركيب</span
                  >
                </div>
              </div>

              <!-- Furniture details -->
              <div class="bg-white rounded-lg p-3 border border-[#EAE9E999] md:col-span-2">
                <h5
                  class="text-[14px] font-medium text-[#4B4B4B] mb-2 text-right border-b border-[#DFDFDF] py-3"
                >
                  تفاصيل الأثاث
                </h5>
                <div class="flex flex-wrap gap-2 text-[12px] mb-3">
                  <span class="px-3 py-1 bg-white text-[#00B8A9] rounded-md border border-gray-200"
                    >5 غرف</span
                  >
                  <span class="px-3 py-1 bg-white text-[#00B8A9] rounded-md border border-gray-200"
                    >2 سجاد</span
                  >
                  <span class="px-3 py-1 bg-white text-[#00B8A9] rounded-md border border-gray-200"
                    >1 مكتب</span
                  >
                  <span class="px-3 py-1 bg-white text-[#00B8A9] rounded-md border border-gray-200"
                    >2 مرايا</span
                  >
                </div>
                <div class="grid grid-cols-3 gap-2">
                  <img
                    src="../assets/landing/truck.png"
                    alt="img"
                    class="w-full h-24 object-cover rounded-md cursor-pointer"
                    data-img-preview
                  />
                  <img
                    src="../assets/landing/truck.png"
                    alt="img"
                    class="w-full h-24 object-cover rounded-md cursor-pointer"
                    data-img-preview
                  />
                  <img
                    src="../assets/landing/truck.png"
                    alt="img"
                    class="w-full h-24 object-cover rounded-md cursor-pointer"
                    data-img-preview
                  />
                </div>
              </div>

              <!-- Map small -->
              <div class="bg-white rounded-lg p-3 border border-[#EAE9E999] md:col-span-2">
                <h5
                  class="text-[14px] font-medium text-[#4B4B4B] mb-2 text-right border-b border-[#DFDFDF] py-3"
                >
                  الموقع
                </h5>
                <div
                  id="order-map"
                  class="w-full h-56 rounded-xl overflow-hidden cursor-pointer"
                ></div>
                <p class="text-xs text-[#7E7E7E] mt-2">اضغط على الخريطة لتكبيرها</p>
              </div>
            </div>
          </div>

          <!-- Updates (collapsible like order details) -->
          <section class="bg-gray-50 mt-4 rounded-2xl p-4">
            <div class="rounded-xl">
              <button
                id="updates-toggle"
                class="w-full flex items-center justify-between text-[14px] font-semibold text-[#3C3D41]"
              >
                <span>التحديثات</span>
                <i id="updates-icon" class="fas fa-chevron-down"></i>
              </button>
              <div id="updates-panel" class="hidden mt-5 border-t border-[#DFDFDF] py-4">
                <div class="space-y-2">
                  <div class="rounded-xl overflow-hidden border border-[#DFDFDF]">
                    <button
                      type="button"
                      class="w-full flex items-center justify-between px-4 py-3 rounded-xl bg-[#01B4AA17] text-[#6B7280] step-toggle"
                      data-target="panel-go-first"
                    >
                      <span>التوجه إلى الموقع الأول</span>
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="panel-go-first" class="hidden rounded-xl overflow-hidden">
                      <div class="bg-[#01B4AA17] p-4 text-start text-[#575757]">
                        <div
                          class="text-[13px] leading-6 font-medium flex items-center gap-2 justify-start"
                        >
                          <img
                            src="../assets/steps/map-marker.svg"
                            alt="location"
                            class="w-4 h-4"
                          />
                          الرياض، حي العلا، شارع فلسطين 5843
                        </div>
                        <div class="my-3 h-px bg-[#DFDFDF]"></div>
                        <div class="text-[13px] leading-6">
                          لقد وصلت إلى الموقع الاول وسأقوم الآن بالفك والتركيب
                        </div>
                        <button
                          data-confirm="update-step"
                          class="mt-4 w-full py-2.5 rounded-xl bg-[#00B8A9] text-white font-bold"
                        >
                          تأكيد
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="rounded-xl overflow-hidden border border-[#DFDFDF]">
                    <button
                      type="button"
                      class="w-full flex items-center justify-between px-4 py-3 rounded-xl bg-[#F1F5F9] text-[#6B7280] step-toggle"
                      data-target="panel-check-furniture"
                    >
                      <span>التحقق من الأثاث</span>
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="panel-check-furniture" class="hidden rounded-xl overflow-hidden">
                      <div class="bg-[#E3F3F2] p-4 text-[#353535]">
                        <div class="text-[13px] font-medium mb-5 text-start">
                          لقد تحققت من تفاصيل الأثاث والغرف
                        </div>
                        <div class="space-y-2">
                          <div class="furn-row grid grid-cols-12 items-center gap-3 rounded-md">
                            <div class="col-span-3 text-sm text-right">غرف</div>
                            <div class="col-span-6 flex items-center justify-center gap-2">
                              <span class="opacity-80">X</span>
                              <input
                                type="number"
                                value="5"
                                disabled
                                class="furn-input w-16 h-9 rounded-md text-center text-[#3C3D41] bg-white/90"
                              />
                            </div>
                            <div class="col-span-3 flex items-center justify-start gap-1">
                              <button
                                class="furn-edit w-7 h-7 rounded-full bg-[#F44336] grid place-items-center text-white text-xs"
                              >
                                <i class="fas fa-pen"></i>
                              </button>
                              <button
                                class="furn-commit w-7 h-7 rounded-full bg-[#01B4AA] grid place-items-center text-white text-xs"
                              >
                                <i class="fas fa-check"></i>
                              </button>
                            </div>
                          </div>
                          <div class="furn-row grid grid-cols-12 items-center gap-3 rounded-md">
                            <div class="col-span-3 text-sm text-right">مرايا</div>
                            <div class="col-span-6 flex items-center justify-center gap-2">
                              <span class="opacity-80">X</span>
                              <input
                                type="number"
                                value="2"
                                disabled
                                class="furn-input w-16 h-9 rounded-md text-center text-[#3C3D41] bg-white/90"
                              />
                            </div>
                            <div class="col-span-3 flex items-center justify-start gap-1">
                              <button
                                class="furn-edit w-7 h-7 rounded-full bg-[#F44336] grid place-items-center text-white text-xs"
                              >
                                <i class="fas fa-pen"></i>
                              </button>
                              <button
                                class="furn-commit w-7 h-7 rounded-full bg-[#01B4AA] grid place-items-center text-white text-xs"
                              >
                                <i class="fas fa-check"></i>
                              </button>
                            </div>
                          </div>
                          <div class="furn-row grid grid-cols-12 items-center gap-3 rounded-md">
                            <div class="col-span-3 text-sm text-right">مكتب</div>
                            <div class="col-span-6 flex items-center justify-center gap-2">
                              <span class="opacity-80">X</span>
                              <input
                                type="number"
                                value="1"
                                disabled
                                class="furn-input w-16 h-9 rounded-md text-center text-[#3C3D41] bg-white/90"
                              />
                            </div>
                            <div class="col-span-3 flex items-center justify-start gap-1">
                              <button
                                class="furn-edit w-7 h-7 rounded-full bg-[#F44336] grid place-items-center text-white text-xs"
                              >
                                <i class="fas fa-pen"></i>
                              </button>
                              <button
                                class="furn-commit w-7 h-7 rounded-full bg-[#01B4AA] grid place-items-center text-white text-xs"
                              >
                                <i class="fas fa-check"></i>
                              </button>
                            </div>
                          </div>
                          <div class="furn-row grid grid-cols-12 items-center gap-3 rounded-md">
                            <div class="col-span-3 text-sm text-right">دواليب</div>
                            <div class="col-span-6 flex items-center justify-center gap-2">
                              <span class="opacity-80">X</span>
                              <input
                                type="number"
                                value="1"
                                disabled
                                class="furn-input w-16 h-9 rounded-md text-center text-[#3C3D41] bg-white/90"
                              />
                            </div>
                            <div class="col-span-3 flex items-center justify-start gap-1">
                              <button
                                class="furn-edit w-7 h-7 rounded-full bg-[#F44336] grid place-items-center text-white text-xs"
                              >
                                <i class="fas fa-pen"></i>
                              </button>
                              <button
                                class="furn-commit w-7 h-7 rounded-full bg-[#01B4AA] grid place-items-center text-white text-xs"
                              >
                                <i class="fas fa-check"></i>
                              </button>
                            </div>
                          </div>
                          <div class="furn-row grid grid-cols-12 items-center gap-3 rounded-md">
                            <div class="col-span-3 text-sm text-right">سرير</div>
                            <div class="col-span-6 flex items-center justify-center gap-2">
                              <span class="opacity-80">X</span>
                              <input
                                type="number"
                                value="4"
                                disabled
                                class="furn-input w-16 h-9 rounded-md text-center text-[#3C3D41] bg-white/90"
                              />
                            </div>
                            <div class="col-span-3 flex items-center justify-start gap-1">
                              <button
                                class="furn-edit w-7 h-7 rounded-full bg-[#F44336] grid place-items-center text-white text-xs"
                              >
                                <i class="fas fa-pen"></i>
                              </button>
                              <button
                                class="furn-commit w-7 h-7 rounded-full bg-[#01B4AA] grid place-items-center text-white text-xs"
                              >
                                <i class="fas fa-check"></i>
                              </button>
                            </div>
                          </div>
                        </div>

                        <!-- Proof of modification (hidden until an item is edited) -->
                        <div id="furn-proof" class="hidden mt-4 rounded-xl p-2 text-white">
                          <div class="text-[14px] font-semibold mb-2 text-[#353535]">
                            توثيق التعديل
                          </div>
                          <div
                            class="rounded-xl border border-dashed border-[#DEDEDE] bg-white p-4 text-center mb-3"
                          >
                            <input
                              id="furn-proof-input"
                              type="file"
                              accept="image/png,image/jpeg,video/mp4"
                              multiple
                              class="hidden"
                            />
                            <button
                              id="furn-proof-trigger"
                              type="button"
                              class="px-3 py-2 rounded-lg text-white text-sm"
                            >
                              <img
                                src="../assets/icons/upload.svg"
                                alt="upload"
                                class="w-10 h-10"
                              />
                            </button>
                            <div class="text-[12px] mt-2 text-[#353535]">
                              أرفق بصيغ PNG, JPG, MP4 لتوثيق التعديل
                            </div>
                          </div>
                          <div id="furn-previews" class="grid grid-cols-2 gap-3 mb-3"></div>
                          <div class="mb-2 text-[14px] text-[#353535]">السعر الإضافي</div>
                          <div class="relative">
                            <input
                              id="furn-extra-price"
                              type="number"
                              min="0"
                              step="1"
                              class="w-full h-10 rounded-lg pl-10 pr-3 text-[#353535]"
                              placeholder="0"
                            />
                            <img
                              id="furn-riyal-icon"
                              src="../assets/icons/riyal.svg"
                              alt="ريال"
                              class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 opacity-90"
                            />
                          </div>
                        </div>

                        <button
                          id="furn-final-confirm"
                          data-confirm
                          disabled
                          class="mt-4 w-full py-2.5 rounded-xl bg-[#01B4AA] text-white font-bold opacity-50 cursor-not-allowed pointer-events-none"
                        >
                          تأكيد
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="rounded-xl overflow-hidden border border-[#DFDFDF]">
                    <button
                      type="button"
                      class="w-full flex items-center justify-between px-4 py-3 rounded-xl bg-[#F1F5F9] text-[#6B7280] step-toggle"
                      data-target="panel-unpack-install"
                    >
                      <span>الفك والتركيب</span>
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="panel-unpack-install" class="hidden rounded-xl overflow-hidden">
                      <div class="bg-[#01B4AA17] p-4 text-start text-[#575757]">
                        <div class="text-[13px] leading-6">
                          قمت بفك الأثاث وتحميله إلى المركبة بلا أي ضرر
                        </div>
                        <a
                          href="#"
                          onclick="return false;"
                          class="block mt-2 text-[13px] text-red-600 font-semibold"
                        >
                          ابلاغ عن ضرر
                        </a>
                        <button
                          data-confirm="update-step"
                          class="mt-4 w-full py-2.5 rounded-xl bg-[#00B8A9] text-white font-bold"
                        >
                          تأكيد
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="rounded-xl overflow-hidden bg-[#01B4AA17] border border-[#DFDFDF]">
                    <button
                      type="button"
                      class="w-full flex items-center justify-between px-4 py-3 rounded-xl text-[#6B7280] step-toggle"
                      data-target="panel-go-delivery"
                    >
                      <span>التوجه إلى موقع التسليم</span>
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="panel-go-delivery" class="hidden rounded-xl overflow-hidden">
                      <div class="bg-[#01B4AA17] p-4 text-start text-[#575757]">
                        <div
                          class="text-[13px] leading-6 font-medium flex items-center gap-2 justify-start"
                        >
                          <img
                            src="../assets/steps/map-marker.svg"
                            alt="location"
                            class="w-4 h-4"
                          />
                          الرياض، حي العلا، شارع فلسطين 5843
                        </div>
                        <div class="my-3 h-px bg-[#DFDFDF]"></div>
                        <div class="text-[13px] leading-6">
                          لقد وصلت إلى موقع التسليم وسأقوم الآن بالتنزيل والتركيب
                        </div>
                        <button
                          data-confirm="update-step"
                          class="mt-4 w-full py-2.5 rounded-xl bg-[#00B8A9] text-white font-bold"
                        >
                          تأكيد
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="rounded-xl overflow-hidden border border-[#DFDFDF]">
                    <button
                      type="button"
                      class="w-full flex items-center justify-between px-4 py-3 rounded-xl bg-[#F1F5F9] text-[#6B7280] step-toggle"
                      data-target="panel-download-install"
                    >
                      <span>التنزيل والتركيب</span>
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="panel-download-install" class="hidden rounded-xl overflow-hidden">
                      <div class="bg-[#01B4AA17] p-4 text-start text-[#575757]">
                        <div class="text-[13px] leading-6">
                          قمت بإنزال الأثاث والتركيب بلا أي ضرر
                        </div>
                        <a
                          href="#"
                          onclick="return false;"
                          class="block mt-2 text-[13px] text-red-600 font-semibold"
                        >
                          ابلاغ عن ضرر
                        </a>
                        <button
                          data-confirm="update-step"
                          class="mt-4 w-full py-2.5 rounded-xl bg-[#00B8A9] text-white font-bold"
                        >
                          تأكيد
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="rounded-xl overflow-hidden border border-[#DFDFDF]">
                    <button
                      type="button"
                      class="w-full flex items-center justify-between px-4 py-3 rounded-xl bg-[#F1F5F9] text-[#6B7280] step-toggle"
                      data-target="panel-finished"
                    >
                      <span>تم إكمال الطلب</span>
                      <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="panel-finished" class="hidden rounded-xl overflow-hidden">
                      <div class="bg-[#01B4AA17] p-4 text-start text-[#575757]">
                        <div class="text-[13px] leading-6">
                          لقد قام العميل بدفع كامل المستحقات وسأقوم بإغلاق الطلب.
                        </div>
                        <button
                          data-confirm="update-step"
                          class="mt-4 w-full py-2.5 rounded-xl bg-[#00B8A9] text-white font-bold"
                        >
                          تأكيد
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </section>
      </div>
    </main>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      function toggleMobileMenu() {
        var el = document.getElementById('mobile-menu-sidebar');
        if (!el) return;
        el.classList.toggle('hidden');
        el.classList.toggle('flex');
      }
      // Collapsible for مراجعة تفاصيل الطلب
      (function () {
        var btn = document.getElementById('order-details-toggle');
        var panel = document.getElementById('order-details');
        var icon = document.getElementById('details-icon');
        if (!btn || !panel) return;
        btn.addEventListener('click', function () {
          panel.classList.toggle('hidden');
          if (icon) icon.classList.toggle('fa-chevron-up');
          if (icon) icon.classList.toggle('fa-chevron-down');
        });
      })();

      // Collapsible for التحديثات
      (function () {
        var btn = document.getElementById('updates-toggle');
        var panel = document.getElementById('updates-panel');
        var icon = document.getElementById('updates-icon');
        if (!btn || !panel) return;
        btn.addEventListener('click', function () {
          panel.classList.toggle('hidden');
          if (icon) icon.classList.toggle('fa-chevron-up');
          if (icon) icon.classList.toggle('fa-chevron-down');
        });
      })();

      // Global confirm modal (reusable across the page)
      (function () {
        var btn = document.getElementById('start-journey-btn');
        var modal = document.createElement('div');
        modal.id = 'confirm-start-modal';
        modal.className =
          'hidden fixed inset-0 z-[9999] items-center justify-center bg-black/60 px-4';
        modal.innerHTML =
          '\
          <div class="relative z-[10000] w-full max-w-md bg-white rounded-2xl p-6 text-center">\
            <h4 id="confirm-title" class="text-[16px] font-semibold text-[#312E37] mb-2">هل أنت متأكد؟</h4>\
            <p id="confirm-desc" class="text-[13px] text-[#6B7280] mb-5">هل أنت متأكد من تفعيل الحالة والانتقال للمرحلة التالية</p>\
            <div class="flex gap-3">\
              <button id="confirm-accept" class="flex-1 py-2.5 rounded-lg bg-[#00B8A9] text-white">تأكيد</button>\
              <button id="confirm-cancel" class="flex-1 py-2.5 rounded-lg bg-[#EDEDED] text-[#7E7E7E]">تراجع</button>\
            </div>\
          </div>';
        document.body.appendChild(modal);
        // place close button on the right for Arabic
        (function () {
          var isAr = (document.documentElement.getAttribute('lang') || '')
            .toLowerCase()
            .startsWith('ar');
          if (isAr) {
            var c = document.getElementById('confirm-close');
            if (c) {
              c.classList.remove('-left-3');
              c.classList.add('-right-3');
            }
          }
        })();
        function open() {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        }
        function close() {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        }
        function openWith(desc) {
          var p = document.getElementById('confirm-desc');
          if (p && typeof desc === 'string') p.textContent = desc;
          open();
        }
        // New global API: window.openConfirm({ onAccept })
        // Uses the same title and description everywhere
        window.openConfirm = function (opts) {
          var options = opts || {};
          var onAccept = typeof options.onAccept === 'function' ? options.onAccept : null;
          var t = document.getElementById('confirm-title');
          var d = document.getElementById('confirm-desc');
          if (t) t.textContent = 'هل أنت متأكد؟';
          if (d) d.textContent = 'هل أنت متأكد من تفعيل الحالة والانتقال للمرحلة التالية';
          var acceptBtn = document.getElementById('confirm-accept');
          if (acceptBtn) {
            // reset previous click handlers
            acceptBtn.onclick = null;
            acceptBtn.addEventListener(
              'click',
              function handleAccept() {
                close();
                if (onAccept) onAccept();
              },
              { once: true }
            );
          }
          open();
        };
        // Backward compatibility
        window.openConfirmWith = openWith;

        // If a specific start button exists, let it open the modal with its own message
        if (btn) {
          btn.addEventListener('click', function () {
            window.openConfirm();
          });
        }
        modal.addEventListener('click', function (e) {
          if (e.target === modal) close();
        });
        var closeBtn = document.getElementById('confirm-close');
        if (closeBtn) closeBtn.addEventListener('click', close);
        document.getElementById('confirm-cancel').addEventListener('click', close);

        // Delegated handler: any element with [data-confirm] opens the modal
        document.addEventListener('click', function (e) {
          var el = e.target.closest('[data-confirm]');
          if (!el) return;
          window.openConfirm({
            onAccept: function () {
              try {
                el.dispatchEvent(new CustomEvent('confirm:accepted', { bubbles: true }));
              } catch (_) {}
            },
          });
          // prevent default actions like link navigation, if any
          e.preventDefault();
        });
      })();

      // Inline collapse for step panels
      (function () {
        var toggles = document.querySelectorAll('.step-toggle');
        if (!toggles.length) return;
        toggles.forEach(function (btn) {
          btn.addEventListener('click', function () {
            var targetId = btn.getAttribute('data-target');
            var panel = document.getElementById(targetId);
            if (!panel) return;
            panel.classList.toggle('hidden');
            var icon = btn.querySelector('i');
            if (icon) {
              icon.classList.toggle('fa-chevron-up');
              icon.classList.toggle('fa-chevron-down');
            }
          });
        });
        // Confirmation now handled globally via delegated listener above
      })();

      // Furniture edit/commit behavior
      (function () {
        var panel = document.getElementById('panel-check-furniture');
        if (!panel) return;
        var proof = document.getElementById('furn-proof');
        var fileInput = document.getElementById('furn-proof-input');
        var fileTrigger = document.getElementById('furn-proof-trigger');
        var previews = document.getElementById('furn-previews');
        var priceInput = document.getElementById('furn-extra-price');
        var riyalIcon = document.getElementById('furn-riyal-icon');

        // Track original values per row
        panel.querySelectorAll('.furn-row').forEach(function (row) {
          var input = row.querySelector('.furn-input');
          if (input) row.dataset.original = String(input.value);
        });

        // Move riyal icon based on language
        (function () {
          var isAr = (document.documentElement.getAttribute('lang') || '')
            .toLowerCase()
            .startsWith('ar');
          if (!riyalIcon || !priceInput) return;
          if (isAr) {
            riyalIcon.classList.remove('right-3');
            riyalIcon.classList.add('left-3');
            priceInput.classList.remove('pr-10');
            priceInput.classList.add('pl-10');
          } else {
            riyalIcon.classList.remove('left-3');
            riyalIcon.classList.add('right-3');
            priceInput.classList.remove('pl-10');
            priceInput.classList.add('pr-10');
          }
        })();

        function updateProofVisibility() {
          var anyEdited = false;
          panel.querySelectorAll('.furn-row').forEach(function (row) {
            if (row.dataset.edited === 'true') anyEdited = true;
          });
          if (proof) {
            proof.classList.toggle('hidden', !anyEdited);
          }
        }

        var finalConfirmBtn = document.getElementById('furn-final-confirm');

        function setConfirmBtnEnabled(enabled) {
          if (!finalConfirmBtn) return;
          if (enabled) {
            finalConfirmBtn.disabled = false;
            finalConfirmBtn.classList.remove(
              'opacity-50',
              'cursor-not-allowed',
              'pointer-events-none'
            );
          } else {
            finalConfirmBtn.disabled = true;
            finalConfirmBtn.classList.add(
              'opacity-50',
              'cursor-not-allowed',
              'pointer-events-none'
            );
          }
        }

        function updateConfirmButton() {
          var rows = panel.querySelectorAll('.furn-row');
          var allConfirmed = true;
          rows.forEach(function (row) {
            if (row.dataset.confirmed !== 'true') allConfirmed = false;
          });
          setConfirmBtnEnabled(allConfirmed);
        }

        function clearEditing() {
          var rows = panel.querySelectorAll('.furn-row');
          rows.forEach(function (row) {
            var input = row.querySelector('.furn-input');
            var commit = row.querySelector('.furn-commit');
            if (input && !input.disabled) {
              // Only reset inputs that are currently in edit mode
              input.disabled = true;
              input.classList.remove('border', 'border-[#EF4351]', 'bg-[#EC404E2E]');
              if (!input.classList.contains('bg-white/90')) input.classList.add('bg-white/90');
            }
            // leave commit buttons enabled by default
          });
          // re-enable all edit buttons
          panel.querySelectorAll('.furn-edit').forEach(function (b) {
            b.classList.remove('opacity-50', 'pointer-events-none');
          });
          updateConfirmButton();
        }

        panel.addEventListener('click', function (e) {
          var editBtn = e.target.closest('.furn-edit');
          if (editBtn && panel.contains(editBtn)) {
            e.preventDefault();
            var row = editBtn.closest('.furn-row');
            if (!row) return;
            clearEditing();
            // disable all other edit buttons
            panel.querySelectorAll('.furn-edit').forEach(function (b) {
              if (b !== editBtn) b.classList.add('opacity-50', 'pointer-events-none');
            });
            var input = row.querySelector('.furn-input');
            var commit = row.querySelector('.furn-commit');
            // mark this row as not confirmed until committed
            row.dataset.confirmed = 'false';
            if (input) {
              input.disabled = false;
              input.classList.remove('bg-white/90');
              input.classList.add('border', 'border-[#EF4351]', 'bg-[#EC404E2E]');
              input.focus();
              input.select();
            }
            if (commit) {
              commit.classList.remove('opacity-50', 'pointer-events-none');
            }
            updateConfirmButton();
            return;
          }

          var commitBtn = e.target.closest('.furn-commit');
          if (commitBtn && panel.contains(commitBtn)) {
            e.preventDefault();
            // accept current edit, then clear editing state
            var row = commitBtn.closest('.furn-row');
            if (row) {
              row.dataset.confirmed = 'true';
              // visually mark commit as done
              commitBtn.classList.add('bg-[#00B8A9]');
              // mark edited only if value changed from original and style input accordingly
              var input = row.querySelector('.furn-input');
              if (input) {
                var original = row.dataset.original || '';
                var isEdited = String(input.value) !== String(original);
                row.dataset.edited = isEdited ? 'true' : 'false';
                input.disabled = true;
                // clear any previous edit styles
                input.classList.remove(
                  'bg-white/90',
                  'border-[#EF4351]',
                  'bg-[#EC404E2E]',
                  'border-[#01B4AA]',
                  'bg-[#01B4AA30]'
                );
                input.classList.add('border');
                if (isEdited) {
                  input.classList.add('border-[#EF4351]', 'bg-[#EC404E2E]');
                } else {
                  input.classList.add('border-[#01B4AA]', 'bg-[#01B4AA30]');
                }
              }
            }
            clearEditing();
            // show proof only if any row edited
            updateProofVisibility();
            updateConfirmButton();
            return;
          }
        });

        // Initialize default state
        panel.querySelectorAll('.furn-row').forEach(function (row) {
          row.dataset.confirmed = 'false';
          row.dataset.edited = 'false';
        });
        clearEditing();
        updateConfirmButton();
        updateProofVisibility();

        // File upload handling
        if (fileTrigger && fileInput) {
          fileTrigger.addEventListener('click', function () {
            fileInput.click();
          });
          fileInput.addEventListener('change', function () {
            if (!fileInput.files || !fileInput.files.length) return;
            Array.from(fileInput.files).forEach(function (file) {
              var url = URL.createObjectURL(file);
              var isVideo = file.type === 'video/mp4';
              var card = document.createElement('div');
              card.className = 'relative rounded-xl overflow-hidden bg-white text-[#3C3D41]';
              card.innerHTML = isVideo
                ? '<video src="' + url + '" class="w-full h-28 object-cover" controls></video>'
                : '<img src="' + url + '" class="w-full h-28 object-cover" />';
              var del = document.createElement('button');
              del.type = 'button';
              del.className =
                'absolute top-2 left-2 w-7 h-7 rounded-full bg-[#00B8A9] text-white grid place-items-center';
              del.innerHTML = '<i class="fas fa-times"></i>';
              del.addEventListener('click', function () {
                URL.revokeObjectURL(url);
                card.remove();
              });
              card.appendChild(del);
              previews.appendChild(card);
            });
            // reset input to allow re-adding same files
            fileInput.value = '';
          });
        }
      })();

      // Image preview modal
      (function () {
        var modal = document.createElement('div');
        modal.id = 'img-modal';
        modal.className =
          'hidden fixed inset-0 z-[9999] items-center justify-center bg-black/60 px-4';
        modal.innerHTML =
          '<div class="relative z-[10000] max-w-4xl w-full bg-white rounded-2xl p-3"><img id="img-modal-src" class="w-full h-[70vh] object-contain rounded-xl" /><button id="img-modal-close" class="absolute -top-3 -left-3 bg-white w-10 h-10 rounded-full grid place-items-center shadow z-[10001]"><i class="fas fa-times"></i></button></div>';
        document.body.appendChild(modal);
        // place close button on the right for Arabic
        (function () {
          var isAr = (document.documentElement.getAttribute('lang') || '')
            .toLowerCase()
            .startsWith('ar');
          if (isAr) {
            var c = document.getElementById('img-modal-close');
            if (c) {
              c.classList.remove('-left-3');
              c.classList.add('-right-3');
            }
          }
        })();
        document.querySelectorAll('[data-img-preview]').forEach(function (img) {
          img.addEventListener('click', function () {
            document.getElementById('img-modal-src').src = img.src;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
          });
        });
        modal.addEventListener('click', function (e) {
          if (e.target === modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
          }
        });
        document.getElementById('img-modal-close').addEventListener('click', function () {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        });
      })();

      // Map + modal
      (function () {
        if (typeof L === 'undefined') return;
        var start = [24.7136, 46.6753];
        var end = [24.746, 46.711];
        var small = L.map('order-map', { zoomControl: true }).setView(start, 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(
          small
        );
        var icon = L.icon({
          iconUrl: '../assets/steps/map-marker.svg',
          iconSize: [36, 36],
          iconAnchor: [18, 36],
        });
        L.marker(start, { icon })
          .addTo(small)
          .bindTooltip('الموقع 1', { permanent: true, direction: 'right' });
        L.marker(end, { icon })
          .addTo(small)
          .bindTooltip('الموقع 2', { permanent: true, direction: 'left' });
        fetch(
          'https://router.project-osrm.org/route/v1/driving/' +
            start[1] +
            ',' +
            start[0] +
            ';' +
            end[1] +
            ',' +
            end[0] +
            '?overview=full&geometries=geojson'
        )
          .then((r) => r.json())
          .then(function (data) {
            var coords =
              (data.routes &&
                data.routes[0] &&
                data.routes[0].geometry &&
                data.routes[0].geometry.coordinates) ||
              [];
            var latlngs = coords.length ? coords.map((c) => [c[1], c[0]]) : [start, end];
            var poly = L.polyline(latlngs, { color: '#00B8A9', weight: 4, opacity: 0.9 }).addTo(
              small
            );
            small.fitBounds(poly.getBounds(), { padding: [20, 20] });
          })
          .catch(function () {
            L.polyline([start, end], { color: '#00B8A9', weight: 4 }).addTo(small);
            small.fitBounds([start, end], { padding: [20, 20] });
          });

        // Map modal element
        var mmodal = document.createElement('div');
        mmodal.id = 'map-modal';
        mmodal.className =
          'hidden fixed inset-0 z-[9999] items-center justify-center bg-black/60 px-4';
        mmodal.innerHTML =
          '<div class="relative z-[10000] w-full max-w-4xl"><div id="order-map-modal" class="w-full h-[70vh] rounded-2xl overflow-hidden bg-[#F4F4F4]"></div><button id="map-modal-close" class="absolute -top-3 -left-3 bg-white w-10 h-10 rounded-full grid place-items-center shadow z-[10001]"><i class="fas fa-times"></i></button></div>';
        document.body.appendChild(mmodal);
        // place close button on the right for Arabic
        (function () {
          var isAr = (document.documentElement.getAttribute('lang') || '')
            .toLowerCase()
            .startsWith('ar');
          if (isAr) {
            var c = document.getElementById('map-modal-close');
            if (c) {
              c.classList.remove('-left-3');
              c.classList.add('-right-3');
            }
          }
        })();
        var big;
        document.getElementById('order-map').addEventListener('click', function () {
          mmodal.classList.remove('hidden');
          mmodal.classList.add('flex');
          setTimeout(function () {
            if (!big) {
              big = L.map('order-map-modal').setView(start, 12);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
              }).addTo(big);
              L.marker(start, { icon })
                .addTo(big)
                .bindTooltip('الموقع 1', { permanent: true, direction: 'right' });
              L.marker(end, { icon })
                .addTo(big)
                .bindTooltip('الموقع 2', { permanent: true, direction: 'left' });
              fetch(
                'https://router.project-osrm.org/route/v1/driving/' +
                  start[1] +
                  ',' +
                  start[0] +
                  ';' +
                  end[1] +
                  ',' +
                  end[0] +
                  '?overview=full&geometries=geojson'
              )
                .then((r) => r.json())
                .then(function (data) {
                  var coords =
                    (data.routes &&
                      data.routes[0] &&
                      data.routes[0].geometry &&
                      data.routes[0].geometry.coordinates) ||
                    [];
                  var latlngs = coords.length ? coords.map((c) => [c[1], c[0]]) : [start, end];
                  var poly = L.polyline(latlngs, {
                    color: '#00B8A9',
                    weight: 5,
                    opacity: 0.95,
                  }).addTo(big);
                  big.fitBounds(poly.getBounds(), { padding: [20, 20] });
                  setTimeout(function () {
                    big.invalidateSize();
                  }, 0);
                })
                .catch(function () {
                  var poly = L.polyline([start, end], {
                    color: '#00B8A9',
                    weight: 5,
                    opacity: 0.95,
                  }).addTo(big);
                  big.fitBounds(poly.getBounds(), { padding: [20, 20] });
                  setTimeout(function () {
                    big.invalidateSize();
                  }, 0);
                });
            } else {
              setTimeout(function () {
                big.invalidateSize();
              }, 0);
            }
          }, 120);
        });
        document.getElementById('map-modal-close').addEventListener('click', function () {
          mmodal.classList.add('hidden');
          mmodal.classList.remove('flex');
        });
        mmodal.addEventListener('click', function (e) {
          if (e.target === mmodal) {
            mmodal.classList.add('hidden');
            mmodal.classList.remove('flex');
          }
        });
      })();
    </script>
  </body>
</html>
